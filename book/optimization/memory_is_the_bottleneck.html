
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memory traffic is the bottleneck &#8212; FYS3150/FYS4150 course material</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Introduction to OpenMP" href="../parallelization/introduction_to_openmp.html" />
    <link rel="prev" title="Online C++ resources" href="../introduction_to_cpp/online_resources.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      <h1 class="site-logo" id="site-title">FYS3150/FYS4150 course material</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Welcome
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Getting ready
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_ready/windows_users.html">
   Windows users
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_ready/mac_users.html">
   Mac users
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_ready/linux_users.html">
   Linux users
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Using the terminal
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../using_the_terminal/basics.html">
   Basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../using_the_terminal/keyboard_shortcuts.html">
   Keyboard shortcuts
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Using git and GitHub
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../using_git/introduction_to_git.html">
   Introduction to git
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../using_git/setting_up_git_and_a_GitHub_repo.html">
   Setting up git and GitHub repo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../using_git/add_a_README.html">
   Add a README
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../using_git/using_git.html">
   Using git
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../using_git/dealing_with_merge_conflicts.html">
   Dealing with merge conflicts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../using_git/recover_an_old_version_of_a_file.html">
   Recover an old version of a file
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../using_git/other_ways_to_fix_mistakes.html">
   Other ways to fix mistakes
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Introduction to C++
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/intro.html">
   Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/hello_world.html">
   Hello World
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/compiling_and_linking_take_1.html">
   Compiling and linking, take 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/source_files_and_header_files.html">
   Source files and header files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/variables.html">
   Variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/functions_take_1.html">
   Functions, take 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/read_command_line_input.html">
   Read command line input
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/write_to_file.html">
   Write to file
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/if_else.html">
   If else
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/loops.html">
   Loops
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/containers.html">
   Containers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/intro_to_armadillo.html">
   Introduction to Armadillo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/pointers.html">
   Pointers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/classes.html">
   Classes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_to_cpp/online_resources.html">
   Online C++ resources
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Optimization
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Memory traffic is the bottleneck
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Parallelization
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../parallelization/introduction_to_openmp.html">
   Introduction to OpenMP
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../parallelization/using_openmp.html">
   Using OpenMP
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Using Make
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../using_make/intro.html">
   Intro
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Writing reports
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../writing_reports/introduction_to_latex.html">
   Introduction to LaTeX
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Projects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../projects/project1.html">
   Project 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../projects/project2.html">
   Project 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../projects/project3.html">
   Project 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../projects/project4.html">
   Project 4
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/book/optimization/memory_is_the_bottleneck.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/anderkve/FYS3150"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/anderkve/FYS3150/issues/new?title=Issue%20on%20page%20%2Fbook/optimization/memory_is_the_bottleneck.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-model-for-the-cpu">
   A model for the CPU
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cache-hit-and-cache-miss">
   Cache hit and cache miss
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#row-and-column-major-order">
   Row- and column-major order
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#row-major-order">
     Row-major order
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#column-major-order">
     Column-major order
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#illustrative-example">
     Illustrative example
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#temporaries">
   Temporaries
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-1-matrix-vector-multiplication">
     Example 1: matrix-vector multiplication
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="memory-traffic-is-the-bottleneck">
<h1>Memory traffic is the bottleneck<a class="headerlink" href="#memory-traffic-is-the-bottleneck" title="Permalink to this headline">¶</a></h1>
<p>The culprit of performance degradation can almost always be attributed to memory traffic. In this tutorial, we’ll discuss a couple things:</p>
<ol class="simple">
<li><p>How memory is accessed by the CPU.</p></li>
<li><p>How we can write code to minimize memory traffic and ultimately make our code as efficient as possible.</p></li>
</ol>
<div class="section" id="a-model-for-the-cpu">
<h2>A model for the CPU<a class="headerlink" href="#a-model-for-the-cpu" title="Permalink to this headline">¶</a></h2>
<p>To understand how and why a certain optimization works, we need to understand a basic high-level model of the <strong>central computing unit</strong>, or <strong>CPU</strong>, of a computer workds. For our purposes, the CPU consists of</p>
<ol class="simple">
<li><p><strong>A set of computing units</strong>. These perform operations on numbers.</p></li>
<li><p><strong>Cache</strong>. This is a type of memory with incredibly fast <strong>memory bandwidth</strong>. This means it transfers data to the computing units quickly.</p></li>
</ol>
<ul class="simple">
<li><p>There’s usually more than one type of cache. The typical hierarchy is <strong>L1</strong>, <strong>L2</strong> and <strong>L3</strong>. The first has the fastest memory bandwidth and lowest capacity. The last has the slowest memory bandwidth but the largest capacity.</p></li>
<li><p>You might have heard of <strong>random access memory</strong>, or <strong>RAM</strong>. Cache memory is much much faster than this!</p></li>
</ul>
<ol class="simple">
<li><p><strong>Registers</strong> which is even faster than cache. But for the most part we’ll only consider the computing units and the cache.</p></li>
</ol>
</div>
<div class="section" id="cache-hit-and-cache-miss">
<h2>Cache hit and cache miss<a class="headerlink" href="#cache-hit-and-cache-miss" title="Permalink to this headline">¶</a></h2>
<p>When a code block is executed, your computer will first search for the variables in the cache first. If the variable is not found in the cache, the CPU must <strong>load</strong> the memory of the variable into cache. But loading a single piece of memory is uneconomic, so instead a <strong>cache line</strong> is loaded. This is a strip of memory addresses. We refer to this process as a <strong>cache miss</strong>.</p>
<p>If the variable <em>is</em> loaded into memory, we refer to it as a <strong>cache hit</strong>. Ideally, we want to maximize the likelihood of a cache hit when we write code. This is generally what optimization of memory bottlenecks is about.</p>
</div>
<div class="section" id="row-and-column-major-order">
<h2>Row- and column-major order<a class="headerlink" href="#row-and-column-major-order" title="Permalink to this headline">¶</a></h2>
<p>It’s important to understand how your computer allocates memory when you writing code. If you make a mistake here, it will severely impede the execution speed of your code! But why?</p>
<p>For the most part, this will be relevant knowledge when we’re working with matrices.</p>
<div class="section" id="row-major-order">
<h3>Row-major order<a class="headerlink" href="#row-major-order" title="Permalink to this headline">¶</a></h3>
<p>In C and C++, memory is allocated in what is known as <strong>row-major</strong> order. For a matrix <code class="docutils literal notranslate"><span class="pre">A[i][j]</span></code>, any two elements on a row <code class="docutils literal notranslate"><span class="pre">i</span></code> is adjacent to each other in memory. We say that the elements on the row is allocated <strong>contiguously</strong>.
When the underlying memory is allocated as row-major, we should traverse the rows to reduce the <strong>stride</strong> through memory. Stride means how many memory addresses we skip over before we reach the desired memory address. If the memory address lies right next to the last one, it’s called <strong>stride-1</strong>. If it lies N addresses away, it’s called <strong>stride-N</strong>.</p>
</div>
<div class="section" id="column-major-order">
<h3>Column-major order<a class="headerlink" href="#column-major-order" title="Permalink to this headline">¶</a></h3>
<p>When memory is allocated in <strong>column-major</strong> order, each column <code class="docutils literal notranslate"><span class="pre">j</span></code> in a matrix <code class="docutils literal notranslate"><span class="pre">A[i][j]</span></code> is allocated contiguously instead. Fortran is a programming language that does this.
We should traverse the columns to reduce the stride in memory when the underlying memory has column-major order.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Armadillo, the linear algebra package for C++, allocates memory in column-major order! If you use this, you must be careful about how you stride through matrices.</p>
</div>
</div>
<div class="section" id="illustrative-example">
<h3>Illustrative example<a class="headerlink" href="#illustrative-example" title="Permalink to this headline">¶</a></h3>
<p>We’ll do an example with Armadillo because it simplifies allocation of matrices significantly. We recall that Armadillo allocates memory in column-major order. Therefore we should make sure to traverse the matrix through its columns (stride-1)!</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
<span class="n">mat</span> <span class="n">A</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
<span class="kt">clock_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kt">clock_t</span> <span class="n">end</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
<span class="kt">double</span> <span class="n">timeused</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">*</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="n">CLOCKS_PER_SEC</span><span class="p">;</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;timeused = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">timeused</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; seconds &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>which outputs</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">timeused</span> <span class="o">=</span> <span class="m">0</span>.474549 seconds
</pre></div>
</div>
<p>If we instead stride through its rows (stride-<code class="docutils literal notranslate"><span class="pre">n</span></code>)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
        <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>we get</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">timeused</span> <span class="o">=</span> <span class="m">0</span>.96181 seconds
</pre></div>
</div>
<p>which is roughly twice as long. Conceptually, cache misses occur much more frequently in a stride-<code class="docutils literal notranslate"><span class="pre">n</span></code> code. Cache lines that are already loaded must be discarded in favor of loading new cache lines. Part of the execution time leaves the computing units idle, waiting for the correct memory addresses to be loaded into cache before they can do any computation.</p>
</div>
</div>
<div class="section" id="temporaries">
<h2>Temporaries<a class="headerlink" href="#temporaries" title="Permalink to this headline">¶</a></h2>
<p>We can often help the compiler by creating <strong>temporary variables</strong>, or <strong>temporaries</strong>, to reduce memory traffic. This is easiest to showcase with a few examples:</p>
<div class="section" id="example-1-matrix-vector-multiplication">
<h3>Example 1: matrix-vector multiplication<a class="headerlink" href="#example-1-matrix-vector-multiplication" title="Permalink to this headline">¶</a></h3>
<p>Let’s look at a simple example of matrix-vector multiplication.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">mat</span> <span class="n">A</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">).</span><span class="n">randu</span><span class="p">();</span> <span class="c1">//Randomlly generated matrix</span>
<span class="n">vec</span> <span class="n">x</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="n">randu</span><span class="p">();</span> <span class="c1">//randomly generated vector</span>
<span class="n">vec</span> <span class="n">y</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="n">n</span><span class="p">).</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+=</span> <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Execution speed for <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">25000</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">timeused</span> <span class="o">=</span> <span class="m">8</span>.70447 seconds
</pre></div>
</div>
<p>On the surface, this looks like a perfectly sensible solution. But there’s a few problems:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x(j)</span></code> is certainly not dependent on the inner loop. By including it there, it’s repeatedly discarded and loaded into cache.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">A(i,</span> <span class="pre">j)</span></code> only partially depend on the inner loop. So here we face the same problem. Cache lines that are loaded in must be discarded to make room for new ones.</p></li>
</ol>
<p>Let’s deal with the point 1 first. Instead of loading the vector, we create a temporary <code class="docutils literal notranslate"><span class="pre">tmp</span></code> for it:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="kt">double</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">x</span><span class="p">(</span><span class="n">j</span><span class="p">);</span> <span class="c1">//Extract element j of the vector</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+=</span> <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Execution speed for <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">25000</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">timeused</span> <span class="o">=</span> <span class="mf">6.76226</span> <span class="n">seconds</span>
</pre></div>
</div>
<p>So we’re seeing improvements. Now, let’s fix point 2. We can load a column of <code class="docutils literal notranslate"><span class="pre">A(i,j)</span></code> using <code class="docutils literal notranslate"><span class="pre">A.col(j)</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="kt">double</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">x</span><span class="p">(</span><span class="n">j</span><span class="p">);</span> <span class="c1">//Extract element j of the vector</span>
    <span class="n">vec</span> <span class="n">tmp_vec</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="n">j</span><span class="p">);</span> <span class="c1">//Extract column j</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+=</span> <span class="n">tmp_vec</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Execution speed for <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">25000</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">timeused</span> <span class="o">=</span> <span class="mf">6.23306</span> <span class="n">seconds</span>
</pre></div>
</div>
<p>so we’re still seeing improvements. Don’t be fooled by the small absolute difference; this is 40% faster than the original code!</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./book/optimization"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="../introduction_to_cpp/online_resources.html" title="previous page">Online C++ resources</a>
    <a class='right-next' id="next-link" href="../parallelization/introduction_to_openmp.html" title="next page">Introduction to OpenMP</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By the FYS3150 teaching team<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>